<!-- Observable -->
<script>
  class Observable {
    constructor(value) {
      // Maybe this can cause an id collision of two observables created almost at the same time
      this._id = `${Math.random()}${+new Date()}`;
      this._value = value;
    }
    emit() {
      window.dispatchEvent(
        new CustomEvent(this._id, {
          detail: this._value,
        })
      );
    }
    get id() {
      return this._id;
    }
    get value() {
      return this._value;
    }
    set value(value) {
      // Maybe this should do a deep compare in case value is an object?
      if (value === this._value) return;
      this._value = value;
      this.emit();
    }
  }
</script>

<!-- HTML Utils -->
<script>
  const createElement$ = (elementType, ...observables) => {
    const element = document.createElement(elementType);
    observables.forEach(observable => {
      if (
        // If it is observable value
        observable instanceof Observable &&
        ['string', 'number'].includes(typeof observable.value)
      ) {
        const textNode = document.createTextNode(observable.value);
        element.appendChild(textNode);
        window.addEventListener(observable.id, ({ detail }) => {
          textNode.nodeValue = detail;
        });
        return;
      }
      if (
        // If it is non-observable value
        ['string', 'number'].includes(typeof observable)
      ) {
        const textNode = document.createTextNode(observable);
        element.appendChild(textNode);
        return;
      }
      // If it is a dom node
      element.appendChild(observable);
    });
    // Note that styleObject$ is an object with observable values, not an observable object
    // TODO: It should also be possible to set the style as a non-observable object
    element.setStyle = styleObject$ => {
      Object.entries(styleObject$).forEach(([styleProperty, styleValue$]) => {
        if (styleValue$ instanceof Observable) {
          element.style[styleProperty] = styleValue$.value;
          window.addEventListener(styleValue$.id, ({ detail }) => {
            element.style[styleProperty] = detail;
          });
          return;
        }
        element.style[styleProperty] = styleValue$;
      });
      return element;
    };
    element.setProps = propsObject => {
      Object.entries(propsObject).forEach(([propKey, propValue$]) => {
        if (propValue$ instanceof Observable) {
          element[propKey] = propValue$.value;
          window.addEventListener(propValue$.id, ({ detail }) => {
            element[propKey] = detail;
          });
          return;
        }
        element[propKey] = propValue$;
      });
      return element;
    };
    element.onClick = clickCallback => {
      element.style.cursor = 'pointer';
      element.onclick = () => clickCallback(element);
      return element;
    };
    element.onMouseEnter = mouseEnterCallback => {
      element.onmouseenter = () => mouseEnterCallback(element);
      return element;
    };
    element.onMouseLeave = mouseLeaveCallback => {
      element.onmouseleave = () => mouseLeaveCallback(element);
      return element;
    };
    element.onInput = inputCallback => {
      element.oninput = () => inputCallback(element);
      return element;
    };
    return element;
  };
  const a$ = (...children) => createElement$('a', ...children);
  const p$ = (...children) => createElement$('p', ...children);
  const button$ = (...children) => createElement$('button', ...children);
  const div$ = (...children) => createElement$('div', ...children);
  const h1$ = (...children) =>
    createElement$('h1', ...children).setStyle({
      margin: '0',
      fontWeight: 'normal',
    });
  const h2$ = (...children) =>
    createElement$('h2', ...children).setStyle({
      margin: '0',
      fontWeight: 'normal',
    });
  const h3$ = (...children) =>
    createElement$('h3', ...children).setStyle({
      margin: '0',
      fontWeight: 'normal',
    });
  const input$ = (value = '') => createElement$('input').setProps({ value });
  const textArea$ = (value = '') =>
    createElement$('textarea').setProps({ value });
  const br$ = () => createElement$('br');
  const canvas$ = ({ width, height }) => {
    const element = createElement('canvas');
    element.width = width;
    element.height = height;
    return element;
  };
</script>

<!-- Utils -->
<script>
  const pipe = value => (...fns) => fns.reduce((value, fn) => fn(value), value);
</script>

<!-- Formatting functions -->
<script>
  const formatQuery = query => pipe(query)();
</script>

<!-- Components -->
<script>
  const CenteredContainer = (...chilren) =>
    div$(...chilren).setStyle({ margin: 'auto', width: '720px' });

  const ExpandableTextArea = value =>
    textArea$(value).onInput(textArea => {
      const previousClientHeight = textArea.clientHeight;
      const { scrollX, scrollY } = window;
      textArea.setStyle({ height: 'auto' });
      textArea.setStyle({ height: `${textArea.scrollHeight}px` });
      const newClientHeight = textArea.clientHeight;
      const scrollChange = newClientHeight - previousClientHeight;
      window.scrollTo(scrollX, scrollY + scrollChange);
    });

  const QueryInput = value =>
    ExpandableTextArea(value).setStyle({
      borderRadius: '5px',
      fontFamily: '"Courier New", Courier, monospace',
      background: 'whiteSmoke',
      minHeight: '10em',
      overflow: 'hidden',
      outline: 'none',
      padding: '10px',
      border: 'none',
      resize: 'none',
      width: '100%',
    });

  const QueryOutput = (...children) =>
    div$(...children).setStyle({
      fontFamily: '"Courier New", Courier, monospace',
      whiteSpace: 'pre-wrap',
      padding: '10px',
    });

  const App = ({ state }) =>
    CenteredContainer(
      QueryInput(state.queryInput$).onInput(({ value }) => {
        state.queryInput$.value = value;
        state.queryOutput$.value = formatQuery(value);
      }),
      QueryOutput(state.queryOutput$)
    );
</script>

<script>
  window.onload = () => {
    const state = {
      queryInput$: new Observable(''),
      queryOutput$: new Observable(''),
    };

    Object.assign(document.body.style, {
      fontFamily: 'Sans-Serif',
      margin: '0px',
    });
    document.body.appendChild(App({ state }));
  };
</script>
