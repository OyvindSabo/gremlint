<!DOCTYPE html>

<style>
  #formatter {
    font-family: Arial;
    color: #2F3D45;
    width: 1200px;
  }
  #inputQuery {
    background-color: #f5f5f5;
    border-radius: 0.5vw;
    border-style:solid;
    font-size: 14px;
    color: #2F3D45;
    outline: none;
    padding: 14px;
    border:none;
    width: 100%;
  }
  #outputQuery {
    word-break: break-all;
    text-align: left;
    padding: 14px;
  }
</style>

<script>
  const spaces = (numberOfSpaces) => {
    spaceArray = [];
    for (let i = 0; i < numberOfSpaces; i++) {
      spaceArray.push('&nbsp;');
    }
    return spaceArray.join('');
  }

  const format = (query) => {
    let dotCount = 0;
    let unclosedParenthesisCount = 0;
    let indentCount = 6;
    let unclosedString = false;
    let unclosedValue = false;
    // Swap all double quotes for single quotes
    query = query.replace(/"/g, "'");
    queryArray = query.split('');
    for (let i = 0; i < queryArray.length; i++) {
      if (queryArray[i] === "'") {
        unclosedString = !unclosedString;
        if (unclosedString) {
          queryArray[i] = "<span style='color:Green;'>" + queryArray[i];
        } else {
          queryArray[i] = queryArray[i] + '</span>';
        }
      }
      if (!unclosedString & /\s/.test(queryArray[i])) {
        queryArray[i] = '';
      }
      if (queryArray[i] === '.') {
        dotCount++;
        if (dotCount > 2) {
          // Check if punctuation newline is required
          if (queryArray[i] === '.') {
            queryArray[i] = queryArray[i] + '<br>' + spaces(indentCount);
          }
        }
      }
      if (dotCount > 1) {
        // Check if open parenthesis newline is required
        if (queryArray[i] === '(') {
          unclosedParenthesisCount++;
          indentCount += 2;
          // If another open parenthesis is found before the closing parenthesis, add newline
          if (query.substr(i+1).indexOf('(') < query.substr(i+1).indexOf(')') && query.substr(i+1).indexOf('(') !== -1) {
            queryArray[i] = queryArray[i] + '<br>' + spaces(indentCount);
          } else if (![')', "'"].includes(queryArray[i+1])) {
            queryArray[i] = queryArray[i] + "<span style='color:Orange;'>"
            unclosedValue = true;
          }
        } else if (queryArray[i] === ')') {
          unclosedParenthesisCount--;
          indentCount -= 2;
          if (unclosedValue) {
            queryArray[i] = '</span>' + queryArray[i];
            unclosedValue = false;
          }
        }
      }
    }
    let formattedQuery = queryArray.join('');
    return '<code>' + formattedQuery + '</code>';
  }
</script>

<body>
  <center>
    <div id='formatter' >
      <form>
        <textarea id='inputQuery'
                  name='input'
                  cols=100
                  rows=10
                  oninput="document.getElementById('outputQuery').innerHTML=format(value);"></textarea>
      </form>
      <div id='outputQuery'></div>
    </div>
  </center>
</body>